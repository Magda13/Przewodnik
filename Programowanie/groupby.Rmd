# Jak wyznaczać agreagaty / statystyki w grupach?

Częstą operacją, którą wykonuje sie na danych, szcezgólnie tych dużych, jest wyznaczanie statystyk / podsumowań / agregatów dla podgrup danych.

Aby takie agregaty wyznaczać z pakietem `dplyr` możemy wykorzystać funkcje `summarise()` i `groupby()`. Pierwsza określa jakie statystyki chcemy policzyć, druga okresla w jakich grupach.

Przedstawimy te funkcje poniżej jedna po drugiej.

## Jak wyznaczać agregaty?

Funkcją `summarise()` można wyznaczyć agregaty w danych.

Przykładowo, poniższa instrukacja dla zbioru danych `auta2012` liczy średnią cenę, pierwiastek z wariancji ceny i medianę przebiegu aut.

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(PogromcyDanych)

auta2012 %>%
  summarise(sredniaCena = mean(Cena.w.PLN),
            sdCena = sqrt(var(Cena.w.PLN)),
            medianaPrzebiegu = median(Przebieg.w.km, na.rm=TRUE))
```

Nie zawsze agregat związany jest z przekształceniem wartości w jakiejś kolumnie.
Przykłądowo, dosyć przydatną statystyką jest liczba wierszy, która nie zalezy od wartości w danych. Taki agregat można wyznaczyć funkcją `n()`.

Wyznaczając agregaty możemy składać funkcje. Przykłądowo składając `mean()` i `grepl()` możemy policzyc procent aut z określonym elementem wyposażenia. 

```{r, warning=FALSE}
auta2012 %>%
  summarise(liczba.aut.z.klimatyzacja = sum(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.klimatyzacja = 100*mean(grepl("klimatyzacja", Wyposazenie.dodatkowe)),
            procent.aut.z.automatem = 100*mean(Skrzynia.biegow == "automatyczna"),
            liczba.aut = n())
```

## Grupowanie

Funkcja `group_by()` pozwala na operacje na agregatach w grupach opisanych przez zmienną jakościową.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n())
```

Agregaty są zwykłą ramką danych, można wykonywać na nich kolejne operacje, np sortowanie.

```{r, warning=FALSE}
auta2012 %>%
  filter(Marka == "Volkswagen", Rok.produkcji == 2007) %>%
  group_by(Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) %>%
  arrange(liczba)
```

---

# Grupowanie po dwóch zmiennych

Grupować można po kilku zmiennych, w tym przypadku agregaty liczone są w każdym podzbiorze zmiennych.

```{r, warning=FALSE}
auta2012 %>%
  filter(Rok.produkcji == 2007, Marka == "Volkswagen") %>%
  group_by(Model, Rodzaj.paliwa) %>%
  summarise(medianaCeny = median(Cena.w.PLN, na.rm=TRUE),
            medianaPrzebieg = median(Przebieg.w.km, na.rm=TRUE),
            liczba = n()) 
```
